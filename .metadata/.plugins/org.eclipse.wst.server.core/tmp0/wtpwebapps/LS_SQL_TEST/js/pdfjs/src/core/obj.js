"use strict";var Name=function(){function t(e){this.name=e}t.prototype={};var n={};t.get=function(r){var i=n[r];return i?i:n[r]=new t(r)};return t}();var Cmd=function(){function t(e){this.cmd=e}t.prototype={};var n={};t.get=function(r){var i=n[r];return i?i:n[r]=new t(r)};return t}();var Dict=function(){function n(e){this.map=Object.create(null);this.xref=e;this.__nonSerializable__=t}var t=function(){return t};n.prototype={assignXref:function(t){this.xref=t},get:function(t,n,r){var i;var s=this.xref;if(typeof (i=this.map[t])!="undefined"||t in this.map||typeof n=="undefined"){return s?s.fetchIfRef(i):i}if(typeof (i=this.map[n])!="undefined"||n in this.map||typeof r=="undefined"){return s?s.fetchIfRef(i):i}i=this.map[r]||null;return s?s.fetchIfRef(i):i},getAsync:function(t,n,r){var i;var s;var o=this.xref;if(typeof (i=this.map[t])!==undefined||t in this.map||typeof n===undefined){if(o){return o.fetchIfRefAsync(i)}s=new LegacyPromise;s.resolve(i);return s}if(typeof (i=this.map[n])!==undefined||n in this.map||typeof r===undefined){if(o){return o.fetchIfRefAsync(i)}s=new LegacyPromise;s.resolve(i);return s}i=this.map[r]||null;if(o){return o.fetchIfRefAsync(i)}s=new LegacyPromise;s.resolve(i);return s},getRaw:function(t){return this.map[t]},getAll:function(){var t={};for(var r in this.map){var i=this.get(r);t[r]=i instanceof n?i.getAll():i}return t},set:function(t,n){this.map[t]=n},has:function(t){return t in this.map},forEach:function(t){for(var n in this.map){t(n,this.get(n))}}};return n}();var Ref=function(){function t(e,t){this.num=e;this.gen=t}t.prototype={};return t}();var RefSet=function(){function t(){this.dict={}}t.prototype={has:function(t){return"R"+t.num+"."+t.gen in this.dict},put:function(t){this.dict["R"+t.num+"."+t.gen]=true},remove:function(t){delete this.dict["R"+t.num+"."+t.gen]}};return t}();var RefSetCache=function(){function t(){this.dict=Object.create(null)}t.prototype={get:function(t){return this.dict["R"+t.num+"."+t.gen]},has:function(t){return"R"+t.num+"."+t.gen in this.dict},put:function(t,n){this.dict["R"+t.num+"."+t.gen]=n},forEach:function(t,n){for(var r in this.dict){t.call(n,this.dict[r])}},clear:function(){this.dict=Object.create(null)}};return t}();var Catalog=function(){function t(e,t){this.pdfManager=e;this.xref=t;this.catDict=t.getCatalogObj();this.fontCache=new RefSetCache;assertWellFormed(isDict(this.catDict),"catalog object is not a dictionary");this.pagePromises=[]}t.prototype={get metadata(){var e=this.catDict.getRaw("Metadata");if(!isRef(e)){return shadow(this,"metadata",null)}var t=!this.xref.encrypt?false:this.xref.encrypt.encryptMetadata;var n=this.xref.fetch(e,!t);var r;if(n&&isDict(n.dict)){var i=n.dict.get("Type");var s=n.dict.get("Subtype");if(isName(i)&&isName(s)&&i.name==="Metadata"&&s.name==="XML"){try{r=stringToUTF8String(bytesToString(n.getBytes()))}catch(o){info("Skipping invalid metadata.")}}}return shadow(this,"metadata",r)},get toplevelPagesDict(){var e=this.catDict.get("Pages");assertWellFormed(isDict(e),"invalid top-level pages dictionary");return shadow(this,"toplevelPagesDict",e)},get documentOutline(){var e=null;try{e=this.readDocumentOutline()}catch(t){if(t instanceof MissingDataException){throw t}warn("Unable to read document outline")}return shadow(this,"documentOutline",e)},readDocumentOutline:function(){var t=this.xref;var n=this.catDict.get("Outlines");var r={items:[]};if(isDict(n)){n=n.getRaw("First");var i=new RefSet;if(isRef(n)){var s=[{obj:n,parent:r}];i.put(n);while(s.length>0){var o=s.shift();var u=t.fetchIfRef(o.obj);if(u===null){continue}if(!u.has("Title")){error("Invalid outline item")}var a=u.get("A");if(a){a=a.get("D")}else if(u.has("Dest")){a=u.getRaw("Dest");if(isName(a)){a=a.name}}var f=u.get("Title");var l={dest:a,title:stringToPDFString(f),color:u.get("C")||[0,0,0],count:u.get("Count"),bold:!!(u.get("F")&2),italic:!!(u.get("F")&1),items:[]};o.parent.items.push(l);n=u.getRaw("First");if(isRef(n)&&!i.has(n)){s.push({obj:n,parent:l});i.put(n)}n=u.getRaw("Next");if(isRef(n)&&!i.has(n)){s.push({obj:n,parent:o.parent});i.put(n)}}}}return r.items.length>0?r.items:null},get numPages(){var e=this.toplevelPagesDict.get("Count");assertWellFormed(isInt(e),"page count in top level pages object is not an integer");return shadow(this,"num",e)},get destinations(){function e(e){return isDict(e)?e.get("D"):e}var t=this.xref;var n={},r,i;var s=this.catDict.get("Names");if(s){r=s.getRaw("Dests")}else if(this.catDict.has("Dests")){i=this.catDict.get("Dests")}if(i){s=i;s.forEach(function(r,i){if(!i){return}n[r]=e(i)})}if(r){var o=new NameTree(r,t);var u=o.getAll();for(var a in u){if(!u.hasOwnProperty(a)){continue}n[a]=e(u[a])}}return shadow(this,"destinations",n)},get javaScript(){var e=this.xref;var t=this.catDict.get("Names");var n=[];if(t&&t.has("JavaScript")){var r=new NameTree(t.getRaw("JavaScript"),e);var i=r.getAll();for(var s in i){if(!i.hasOwnProperty(s)){continue}var o=i[s];if(!isDict(o)){continue}var u=o.get("S");if(!isName(u)||u.name!=="JavaScript"){continue}var a=o.get("JS");if(!isString(a)&&!isStream(a)){continue}if(isStream(a)){a=bytesToString(a.getBytes())}n.push(stringToPDFString(a))}}return shadow(this,"javaScript",n)},cleanup:function(){this.fontCache.forEach(function(e){delete e.sent;delete e.translated});this.fontCache.clear()},getPage:function(t){if(!(t in this.pagePromises)){this.pagePromises[t]=this.getPageDict(t).then(function(e){var n=e[0];var r=e[1];return new Page(this.pdfManager,this.xref,t,n,r,this.fontCache)}.bind(this))}return this.pagePromises[t]},getPageDict:function(t){function o(){while(r.length){var e=r.pop();if(isRef(e)){s.fetchAsync(e).then(function(s){if(isDict(s,"Page")||isDict(s)&&!s.has("Kids")){if(t===i){n.resolve([s,e])}else{i++;o()}return}r.push(s);o()}.bind(this),n.reject.bind(n));return}assert(isDict(e),"page dictionary kid reference points to wrong type of object");var u=e.get("Count");if(i+u<=t){i+=u;continue}var a=e.get("Kids");assert(isArray(a),"page dictionary kids object is not an array");if(u===a.length){r=[a[t-i]];i=t;continue}else{for(var f=a.length-1;f>=0;f--){r.push(a[f])}}}n.reject("Page index "+t+" not found.")}var n=new LegacyPromise;var r=[this.catDict.getRaw("Pages")];var i=0;var s=this.xref;o();return n},getPageIndex:function(t){function r(e){var t=0;var r;return n.fetchAsync(e).then(function(e){if(!e){return null}r=e.getRaw("Parent");return e.getAsync("Parent")}).then(function(e){if(!e){return null}return e.getAsync("Kids")}).then(function(i){if(!i){return null}var s=[];var o=false;for(var u=0;u<i.length;u++){var a=i[u];assert(isRef(a),"kids must be a ref");if(a.num==e.num){o=true;break}s.push(n.fetchAsync(a).then(function(e){if(e.has("Count")){var n=e.get("Count");t+=n}else{t++}}))}if(!o){error("kid ref not found in parents kids")}return Promise.all(s).then(function(){return[t,r]})})}function s(e){return r(e).then(function(e){if(!e){return i}var t=e[0];var n=e[1];i+=t;return s(n)})}var n=this.xref;var i=0;return s(t)}};return t}();var XRef=function(){function t(e,t){this.stream=e;this.entries=[];this.xrefstms={};this.cache=[];this.password=t}t.prototype={setStartXRef:function(t){this.startXRefQueue=[t]},parse:function(t){var n;if(!t){n=this.readXRef()}else{warn("Indexing all PDF objects");n=this.indexObjects()}n.assignXref(this);this.trailer=n;var r=n.get("Encrypt");if(r){var i=n.get("ID");var s=i&&i.length?i[0]:"";this.encrypt=new CipherTransformFactory(r,s,this.password)}if(!(this.root=n.get("Root"))){error("Invalid root reference")}},processXRefTable:function(t){if(!("tableState"in this)){this.tableState={entryNum:0,streamPos:t.lexer.stream.pos,parserBuf1:t.buf1,parserBuf2:t.buf2}}var n=this.readXRefTable(t);if(!isCmd(n,"trailer")){error("Invalid XRef table: could not find trailer dictionary")}var r=t.getObj();if(!isDict(r)){error("Invalid XRef table: could not parse trailer dictionary")}delete this.tableState;return r},readXRefTable:function(t){var n=t.lexer.stream;var r=this.tableState;n.pos=r.streamPos;t.buf1=r.parserBuf1;t.buf2=r.parserBuf2;var i;while(true){if(!("firstEntryNum"in r)||!("entryCount"in r)){if(isCmd(i=t.getObj(),"trailer")){break}r.firstEntryNum=i;r.entryCount=t.getObj()}var s=r.firstEntryNum;var o=r.entryCount;if(!isInt(s)||!isInt(o)){error("Invalid XRef table: wrong types in subsection header")}for(var u=r.entryNum;u<o;u++){r.streamPos=n.pos;r.entryNum=u;r.parserBuf1=t.buf1;r.parserBuf2=t.buf2;var a={};a.offset=t.getObj();a.gen=t.getObj();var f=t.getObj();if(isCmd(f,"f")){a.free=true}else if(isCmd(f,"n")){a.uncompressed=true}if(!isInt(a.offset)||!isInt(a.gen)||!(a.free||a.uncompressed)){console.log(a.offset,a.gen,a.free,a.uncompressed);error("Invalid entry in XRef subsection: "+s+", "+o)}if(!this.entries[u+s]){this.entries[u+s]=a}}r.entryNum=0;r.streamPos=n.pos;r.parserBuf1=t.buf1;r.parserBuf2=t.buf2;delete r.firstEntryNum;delete r.entryCount}if(s===1&&this.entries[1]&&this.entries[1].free){this.entries.shift()}if(this.entries[0]&&!this.entries[0].free){error("Invalid XRef table: unexpected first object")}return i},processXRefStream:function(t){if(!("streamState"in this)){var n=t.dict;var r=n.get("W");var i=n.get("Index");if(!i){i=[0,n.get("Size")]}this.streamState={entryRanges:i,byteWidths:r,entryNum:0,streamPos:t.pos}}this.readXRefStream(t);delete this.streamState;return t.dict},readXRefStream:function(t){var n,r;var i=this.streamState;t.pos=i.streamPos;var s=i.byteWidths;var o=s[0];var u=s[1];var a=s[2];var f=i.entryRanges;while(f.length>0){var l=f[0];var c=f[1];if(!isInt(l)||!isInt(c)){error("Invalid XRef range fields: "+l+", "+c)}if(!isInt(o)||!isInt(u)||!isInt(a)){error("Invalid XRef entry fields length: "+l+", "+c)}for(n=i.entryNum;n<c;++n){i.entryNum=n;i.streamPos=t.pos;var h=0,p=0,d=0;for(r=0;r<o;++r){h=h<<8|t.getByte()}if(o===0){h=1}for(r=0;r<u;++r){p=p<<8|t.getByte()}for(r=0;r<a;++r){d=d<<8|t.getByte()}var v={};v.offset=p;v.gen=d;switch(h){case 0:v.free=true;break;case 1:v.uncompressed=true;break;case 2:break;default:error("Invalid XRef entry type: "+h)}if(!this.entries[l+n]){this.entries[l+n]=v}}i.entryNum=0;i.streamPos=t.pos;f.splice(0,2)}},indexObjects:function(){function t(e,t){var n="",r=e[t];while(r!==13&&r!==10){if(++t>=e.length){break}n+=String.fromCharCode(r);r=e[t]}return n}function n(e,t,n){var r=n.length,i=e.length;var s=0;while(t<i){var o=0;while(o<r&&e[t+o]==n[o]){++o}if(o>=r){break}t++;s++}return s}var r=new Uint8Array([116,114,97,105,108,101,114]);var i=new Uint8Array([115,116,97,114,116,120,114,101,102]);var s=new Uint8Array([101,110,100,111,98,106]);var o=new Uint8Array([47,88,82,101,102]);var u=this.stream;u.pos=0;var a=u.getBytes();var f=u.start,l=a.length;var c=[],h=[];var p=0;var d;while(f<l){var v=a[f];if(v===32||v===9||v===13||v===10){++f;continue}if(v===37){do{++f;if(f>=l){break}v=a[f]}while(v!==13&&v!==10);continue}var m=t(a,f);var g;if(m==="xref"){f+=n(a,f,r);c.push(f);f+=n(a,f,i)}else if(g=/^(\d+)\s+(\d+)\s+obj\b/.exec(m)){this.entries[g[1]]={offset:f,gen:g[2]|0,uncompressed:true};var y=n(a,f,s)+7;var b=a.subarray(f,f+y);var w=n(b,0,o);if(w<y&&b[w+5]<64){h.push(f);this.xrefstms[f]=1}f+=y}else{f+=m.length+1}}for(var E=0,S=h.length;E<S;++E){this.startXRefQueue.push(h[E]);this.readXRef(true)}var x;for(var E=0,S=c.length;E<S;++E){u.pos=c[E];var T=new Parser(new Lexer(u),true,null);var N=T.getObj();if(!isCmd(N,"trailer")){continue}if(!isDict(x=T.getObj())){continue}if(x.has("ID")){return x}}if(x){return x}throw new InvalidPDFException("Invalid PDF structure")},readXRef:function(t){var n=this.stream;try{while(this.startXRefQueue.length){var r=this.startXRefQueue[0];n.pos=r+n.start;var i=new Parser(new Lexer(n),true,null);var s=i.getObj();var o;if(isCmd(s,"xref")){o=this.processXRefTable(i);if(!this.topDict){this.topDict=o}s=o.get("XRefStm");if(isInt(s)){var u=s;if(!(u in this.xrefstms)){this.xrefstms[u]=1;this.startXRefQueue.push(u)}}}else if(isInt(s)){if(!isInt(i.getObj())||!isCmd(i.getObj(),"obj")||!isStream(s=i.getObj())){error("Invalid XRef stream")}o=this.processXRefStream(s);if(!this.topDict){this.topDict=o}if(!o){error("Failed to read XRef stream")}}else{error("Invalid XRef stream header")}s=o.get("Prev");if(isInt(s)){this.startXRefQueue.push(s)}else if(isRef(s)){this.startXRefQueue.push(s.num)}this.startXRefQueue.shift()}return this.topDict}catch(a){if(a instanceof MissingDataException){throw a}info("(while reading XRef): "+a)}if(t){return}throw new XRefParseException},getEntry:function(t){var n=this.entries[t];if(n!==null&&!n.free&&n.offset){return n}return null},fetchIfRef:function(t){if(!isRef(t)){return t}return this.fetch(t)},fetch:function(t,n){assertWellFormed(isRef(t),"ref object is not a reference");var r=t.num;if(r in this.cache){var i=this.cache[r];return i}var s=this.getEntry(r);if(s===null){return this.cache[r]=null}if(s.uncompressed){return this.fetchUncompressed(t,s,n)}else{return this.fetchCompressed(s,n)}},fetchUncompressed:function(t,n,r){var i=t.gen;var s=t.num;if(n.gen!==i){error("inconsistent generation in XRef")}var o=this.stream.makeSubStream(n.offset+this.stream.start);var u=new Parser(new Lexer(o),true,this);var a=u.getObj();var f=u.getObj();var l=u.getObj();if(!isInt(a)||parseInt(a,10)!==s||!isInt(f)||parseInt(f,10)!==i||!isCmd(l)){error("bad XRef entry")}if(!isCmd(l,"obj")){if(l.cmd.indexOf("obj")===0){s=parseInt(l.cmd.substring(3),10);if(!isNaN(s)){return s}}error("bad XRef entry")}if(this.encrypt&&!r){try{n=u.getObj(this.encrypt.createCipherTransform(s,i))}catch(c){return this.fetch(t,true)}}else{n=u.getObj()}if(!isStream(n)){this.cache[s]=n}return n},fetchCompressed:function(t,n){var r=t.offset;var i=this.fetch(new Ref(r,0));if(!isStream(i)){error("bad ObjStm stream")}var s=i.dict.get("First");var o=i.dict.get("N");if(!isInt(s)||!isInt(o)){error("invalid first and n parameters for ObjStm stream")}var u=new Parser(new Lexer(i),false,this);u.allowStreams=true;var a,f=[],l,c=[];for(a=0;a<o;++a){l=u.getObj();if(!isInt(l)){error("invalid object number in the ObjStm stream: "+l)}c.push(l);var h=u.getObj();if(!isInt(h)){error("invalid object offset in the ObjStm stream: "+h)}}for(a=0;a<o;++a){f.push(u.getObj());l=c[a];var p=this.entries[l];if(p&&p.offset===r&&p.gen===a){this.cache[l]=f[a]}}t=f[t.gen];if(t===undefined){error("bad XRef entry for compressed object")}return t},fetchIfRefAsync:function(t){if(!isRef(t)){var n=new LegacyPromise;n.resolve(t);return n}return this.fetchAsync(t)},fetchAsync:function(t,n){var r=new LegacyPromise;var i=function(e){try{e.resolve(this.fetch(t,n))}catch(r){if(r instanceof MissingDataException){this.stream.manager.requestRange(r.begin,r.end,i);return}e.reject(r)}}.bind(this,r);i();return r},getCatalogObj:function(){return this.root}};return t}();var NameTree=function(){function t(e,t){this.root=e;this.xref=t}t.prototype={getAll:function(){var t={};if(!this.root){return t}var n=this.xref;var r=new RefSet;r.put(this.root);var i=[this.root];while(i.length>0){var s,o;var u=n.fetchIfRef(i.shift());if(!isDict(u)){continue}if(u.has("Kids")){var a=u.get("Kids");for(s=0,o=a.length;s<o;s++){var f=a[s];if(r.has(f)){error("invalid destinations")}i.push(f);r.put(f)}continue}var l=u.get("Names");if(l){for(s=0,o=l.length;s<o;s+=2){t[l[s]]=n.fetchIfRef(l[s+1])}}}return t}};return t}();var ObjectLoader=function(){function e(e){return isRef(e)||isDict(e)||isArray(e)||isStream(e)}function t(t,n){if(isDict(t)||isStream(t)){var r;if(isDict(t)){r=t.map}else{r=t.dict.map}for(var i in r){var s=r[i];if(e(s)){n.push(s)}}}else if(isArray(t)){for(var o=0,u=t.length;o<u;o++){var s=t[o];if(e(s)){n.push(s)}}}}function n(e,t,n){this.obj=e;this.keys=t;this.xref=n;this.refSet=null}n.prototype={load:function(){var t=this.keys;this.promise=new LegacyPromise;if(!(this.xref.stream instanceof ChunkedStream)||this.xref.stream.getMissingChunks().length===0){this.promise.resolve();return this.promise}this.refSet=new RefSet;var n=[];for(var r=0;r<t.length;r++){n.push(this.obj[t[r]])}this.walk(n);return this.promise},walk:function(n){var r=[];var i=[];while(n.length){var s=n.pop();if(isRef(s)){if(this.refSet.has(s)){continue}try{var o=s;this.refSet.put(o);s=this.xref.fetch(s)}catch(u){if(!(u instanceof MissingDataException)){throw u}r.push(s);i.push({begin:u.begin,end:u.end})}}if(s&&s.getBaseStreams){var a=s.getBaseStreams();var f=false;for(var l=0;l<a.length;l++){var c=a[l];if(c.getMissingChunks&&c.getMissingChunks().length){f=true;i.push({begin:c.start,end:c.end})}}if(f){r.push(s)}}t(s,n)}if(i.length){this.xref.stream.manager.requestRanges(i,function(){n=r;for(var t=0;t<r.length;t++){var i=r[t];if(isRef(i)){this.refSet.remove(i)}}this.walk(n)}.bind(this));return}this.refSet=null;this.promise.resolve()}};return n}()
"use strict";var PDFImage=function(){function t(e,t,n,r,i){if(r instanceof JpegStream&&r.isNativelyDecodable(t,n)){var s=r.dict;var o=s.get("ColorSpace","CS");o=ColorSpace.parse(o,t,n);var u=o.numComps;e.send("JpegDecode",[r.getIR(),u],function(e){var t=e.data;var n=new Stream(t,0,t.length,r.dict);i.resolve(n)})}else{i.resolve(r)}}function n(e,t,n,r){e=t+e*n;return e<0?0:e>r?r:e}function r(e,t,n,i,s,o,u){this.image=n;if(n.getParams){warn("get params from actual stream")}var a=n.dict;this.width=a.get("Width","W");this.height=a.get("Height","H");if(this.width<1||this.height<1){error("Invalid image width: "+this.width+" or height: "+this.height)}this.interpolate=a.get("Interpolate","I")||false;this.imageMask=a.get("ImageMask","IM")||false;this.matte=a.get("Matte")||false;var f=n.bitsPerComponent;if(!f){f=a.get("BitsPerComponent","BPC");if(!f){if(this.imageMask){f=1}else{error("Bits per component missing in image: "+this.imageMask)}}}this.bpc=f;if(!this.imageMask){var l=a.get("ColorSpace","CS");if(!l){warn("JPX images (which do not require color spaces)");l=Name.get("DeviceRGB")}this.colorSpace=ColorSpace.parse(l,e,t);this.numComps=this.colorSpace.numComps}this.decode=a.get("Decode","D");this.needsDecode=false;if(this.decode&&(this.colorSpace&&!this.colorSpace.isDefaultDecode(this.decode)||u&&!ColorSpace.isDefaultDecode(this.decode,1))){this.needsDecode=true;var c=(1<<f)-1;this.decodeCoefficients=[];this.decodeAddends=[];for(var h=0,p=0;h<this.decode.length;h+=2,++p){var d=this.decode[h];var v=this.decode[h+1];this.decodeCoefficients[p]=v-d;this.decodeAddends[p]=c*d}}if(s){this.smask=new r(e,t,s,false)}else if(o){if(isStream(o)){this.mask=new r(e,t,o,false,null,null,true)}else{this.mask=o}}}r.buildImage=function(n,i,s,o,u,a){var f=new LegacyPromise;var l=new LegacyPromise;var c=new LegacyPromise;Promise.all([f,l,c]).then(function(e){var t=e[0],i=e[1],u=e[2];var f=new r(s,o,t,a,i,u);n(f)});t(i,s,o,u,f);var h=u.dict.get("SMask");var p=u.dict.get("Mask");if(h){t(i,s,o,h,l);c.resolve(null)}else{l.resolve(null);if(p){if(isStream(p)){t(i,s,o,p,c)}else if(isArray(p)){c.resolve(p)}else{warn("Unsupported mask format.");c.resolve(null)}}else{c.resolve(null)}}};r.resize=function(t,n,r,i,s,o,u){var a=o*u*r;var f=n<=8?new Uint8Array(a):n<=16?new Uint16Array(a):new Uint32Array(a);var l=i/o;var c=s/u;var h,p,d,v;for(var m=0;m<u;m++){for(var g=0;g<o;g++){h=Math.floor(g*l);p=Math.floor(m*c);d=m*o+g;v=p*i+h;if(r===1){f[d]=t[v]}else if(r===3){d*=3;v*=3;f[d]=t[v];f[d+1]=t[v+1];f[d+2]=t[v+2]}}}return f};r.createMask=function(t,n,r,i,s){var o=t.byteLength;var u;if(i){u=t}else{u=new Uint8Array(o);u.set(t)}if(s){for(var a=0;a<o;a++){u[a]=~u[a]}}return{data:u,width:n,height:r}};r.prototype={get drawWidth(){return Math.max(this.width,this.smask&&this.smask.width||0,this.mask&&this.mask.width||0)},get drawHeight(){return Math.max(this.height,this.smask&&this.smask.height||0,this.mask&&this.mask.height||0)},decodeBuffer:function(t){var r=this.bpc;var i=this.decode;var s=this.numComps;var o,u;var o=this.decodeAddends;var u=this.decodeCoefficients;var a=(1<<r)-1;if(r===1){for(var f=0,l=t.length;f<l;f++){t[f]=+!t[f]}return}var c=0;for(var f=0,l=this.width*this.height;f<l;f++){for(var h=0;h<s;h++){t[c]=n(t[c],o[h],u[h],a);c++}}},getComponents:function(t){var n=this.bpc;if(n===8){return t}var r=this.width;var i=this.height;var s=this.numComps;var o=r*i*s;var u=0;var a=n<=8?new Uint8Array(o):n<=16?new Uint16Array(o):new Uint32Array(o);var f=r*s;var l=(1<<n)-1;if(n===1){var c=0,h,p,d,v;for(var m=0;m<i;m++){d=c+(f&~7);v=c+f;while(c<d){h=t[u++];a[c]=h>>7&1;a[c+1]=h>>6&1;a[c+2]=h>>5&1;a[c+3]=h>>4&1;a[c+4]=h>>3&1;a[c+5]=h>>2&1;a[c+6]=h>>1&1;a[c+7]=h&1;c+=8}if(c<v){h=t[u++];p=128;while(c<v){a[c++]=+!!(h&p);p>>=1}}}}else{var g=0,h=0;for(var c=0,y=o;c<y;++c){if(c%f===0){h=0;g=0}while(g<n){h=h<<8|t[u++];g+=8}var b=g-n;var w=h>>b;a[c]=w<0?0:w>l?l:w;h=h&(1<<b)-1;g=b}}return a},fillOpacity:function(t,n,i,s,o){var u=this.smask;var a=this.mask;var f;if(u){var l=u.width;var c=u.height;f=new Uint8Array(l*c);u.fillGrayBuffer(f);if(l!=n||c!=i){f=r.resize(f,u.bpc,1,l,c,n,i)}}else if(a){if(a instanceof r){var l=a.width;var c=a.height;f=new Uint8Array(l*c);a.numComps=1;a.fillGrayBuffer(f);for(var h=0,p=l*c;h<p;++h){f[h]=255-f[h]}if(l!=n||c!=i){f=r.resize(f,a.bpc,1,l,c,n,i)}}else if(isArray(a)){f=new Uint8Array(n*i);var d=this.numComps;for(var h=0,p=n*i;h<p;++h){var v=0;var m=h*d;for(var g=0;g<d;++g){var y=o[m+g];var b=g*2;if(y<a[b]||y>a[b+1]){v=255;break}}f[h]=v}}else{error("Unknown mask format.")}}if(f){for(var h=0,g=3,p=n*s;h<p;++h,g+=4){t[g]=f[h]}}else{for(var h=0,g=3,p=n*s;h<p;++h,g+=4){t[g]=255}}},undoPreblend:function(t,n,r){function s(e){return(e<0?0:e>255?255:e)|0}var i=this.smask&&this.smask.matte;if(!i){return}var o=this.colorSpace.getRgb(i,0);var u=n*r*4;for(var a=0;a<u;a+=4){var f=t[a+3];if(f===0){t[a]=255;t[a+1]=255;t[a+2]=255;continue}var l=255/f;t[a]=s((t[a]-o[0])*l+o[0]);t[a+1]=s((t[a+1]-o[1])*l+o[1]);t[a+2]=s((t[a+2]-o[2])*l+o[2])}},createImageData:function(t){var n=this.drawWidth;var r=this.drawHeight;var i={width:n,height:r};var s=this.numComps;var o=this.width;var u=this.height;var a=this.bpc;var f=o*s*a+7>>3;var l=this.getImageBytes(u*f);if(!t){var c;if(this.colorSpace.name==="DeviceGray"&&a===1){c=ImageKind.GRAYSCALE_1BPP}else if(this.colorSpace.name==="DeviceRGB"&&a===8){c=ImageKind.RGB_24BPP}if(c&&!this.smask&&!this.mask&&!this.needsDecode&&n===o&&r===u){i.kind=c;if(this.image instanceof DecodeStream){i.data=l}else{var h=new Uint8Array(l.length);h.set(l);i.data=h}return i}}var p=0|l.length/f*r/u;var d=this.getComponents(l);var v,m;if(!t&&!this.smask&&!this.mask){i.kind=ImageKind.RGB_24BPP;i.data=new Uint8Array(n*r*3);v=0;m=false}else{i.kind=ImageKind.RGBA_32BPP;i.data=new Uint8Array(n*r*4);v=1;m=true;this.fillOpacity(i.data,n,r,p,d)}if(this.needsDecode){this.decodeBuffer(d)}this.colorSpace.fillRgb(i.data,o,u,n,r,p,a,d,v);if(m){this.undoPreblend(i.data,n,p)}return i},fillGrayBuffer:function(t){var n=this.numComps;if(n!=1){error("Reading gray scale from a color image: "+n)}var r=this.width;var i=this.height;var s=this.bpc;var o=r*n*s+7>>3;var u=this.getImageBytes(i*o);var a=this.getComponents(u);if(s===1){var f=r*i;if(this.needsDecode){for(var l=0;l<f;++l){t[l]=a[l]-1&255}}else{for(var l=0;l<f;++l){t[l]=-a[l]&255}}return}if(this.needsDecode){this.decodeBuffer(a)}var f=r*i;var c=255/((1<<s)-1);for(var l=0;l<f;++l){t[l]=c*a[l]|0}},getImageBytes:function(t){this.image.reset();return this.image.getBytes(t)}};return r}()
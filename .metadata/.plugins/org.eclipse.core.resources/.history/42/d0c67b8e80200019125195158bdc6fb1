var JpegImage=function(){"use strict";function l(){}function c(e,t){var n=0,r=[],i,s,o=16;while(o>0&&!e[o-1])o--;r.push({children:[],index:0});var u=r[0],a;for(i=0;i<o;i++){for(s=0;s<e[i];s++){u=r.pop();u.children[u.index]=t[n];while(u.index>0){u=r.pop()}u.index++;r.push(u);while(r.length<=i){r.push(a={children:[],index:0});u.children[u.index]=a.children;u=a}n++}if(i+1<o){r.push(a={children:[],index:0});u.children[u.index]=a.children;u=a}}return r[0].children}function h(e,t,n){return 64*((e.blocksPerLine+1)*t+n)}function p(e,n,r,i,s,o,u,a,f){function E(){if(w>0){w--;return b>>w&1}b=e[n++];if(b==255){var t=e[n++];if(t){throw"unexpected marker: "+(b<<8|t).toString(16)}}w=7;return b>>>7}function S(e){var t=e;var n;while((n=E())!==null){t=t[n];if(typeof t==="number")return t;if(typeof t!=="object")throw"invalid huffman sequence"}return null}function x(e){var t=0;while(e>0){var n=E();if(n===null)return;t=t<<1|n;e--}return t}function T(e){var t=x(e);if(t>=1<<e-1)return t;return t+(-1<<e)+1}function N(e,n){var r=S(e.huffmanTableDC);var i=r===0?0:T(r);e.blockData[n]=e.pred+=i;var s=1;while(s<64){var o=S(e.huffmanTableAC);var u=o&15,a=o>>4;if(u===0){if(a<15)break;s+=16;continue}s+=a;var f=t[s];e.blockData[n+f]=T(u);s++}}function C(e,t){var n=S(e.huffmanTableDC);var r=n===0?0:T(n)<<f;e.blockData[t]=e.pred+=r}function k(e,t){e.blockData[t]|=E()<<f}function A(e,n){if(L>0){L--;return}var r=o,i=u;while(r<=i){var s=S(e.huffmanTableAC);var a=s&15,l=s>>4;if(a===0){if(l<15){L=x(l)+(1<<l)-1;break}r+=16;continue}r+=l;var c=t[r];e.blockData[n+c]=T(a)*(1<<f);r++}}function _(e,n){var r=o,i=u,s=0;while(r<=i){var a=t[r];switch(O){case 0:var l=S(e.huffmanTableAC);var c=l&15,s=l>>4;if(c===0){if(s<15){L=x(s)+(1<<s);O=4}else{s=16;O=1}}else{if(c!==1)throw"invalid ACn encoding";M=T(c);O=s?2:3}continue;case 1:case 2:if(e.blockData[n+a]){e.blockData[n+a]+=E()<<f}else{s--;if(s===0)O=O==2?3:0}break;case 3:if(e.blockData[n+a]){e.blockData[n+a]+=E()<<f}else{e.blockData[n+a]=M<<f;O=0}break;case 4:if(e.blockData[n+a]){e.blockData[n+a]+=E()<<f}break}r++}if(O===4){L--;if(L===0)O=0}}function D(e,t,n,r,i){var s=n/d|0;var o=n%d;var u=s*e.v+r;var a=o*e.h+i;var f=h(e,u,a);t(e,f)}function P(e,t,n){var r=n/e.blocksPerLine|0;var i=n%e.blocksPerLine;var s=h(e,r,i);t(e,s)}var l=r.precision;var c=r.samplesPerLine;var p=r.scanLines;var d=r.mcusPerLine;var v=r.progressive;var m=r.maxH,g=r.maxV;var y=n,b=0,w=0;var L=0;var O=0,M;var H=i.length;var B,j,F,I,q;var R;if(v){if(o===0)R=a===0?C:k;else R=a===0?A:_}else{R=N}var U=0,z;var W;if(H==1){W=i[0].blocksPerLine*i[0].blocksPerColumn}else{W=d*r.mcusPerColumn}if(!s){s=W}var X,V;while(U<W){for(j=0;j<H;j++){i[j].pred=0}L=0;if(H==1){B=i[0];for(q=0;q<s;q++){P(B,R,U);U++}}else{for(q=0;q<s;q++){for(j=0;j<H;j++){B=i[j];X=B.h;V=B.v;for(F=0;F<V;F++){for(I=0;I<X;I++){D(B,R,U,F,I)}}}U++}}w=0;z=e[n]<<8|e[n+1];if(z<=65280){throw"marker was not found"}if(z>=65488&&z<=65495){n+=2}else{break}}return n-y}function d(e,t,l){var c=e.quantizationTable;var h,p,d,v,g,y,b,w,E;var S;for(S=0;S<64;S++){l[S]=e.blockData[t+S]*c[S]}for(S=0;S<8;++S){var x=8*S;if(l[1+x]==0&&l[2+x]==0&&l[3+x]==0&&l[4+x]==0&&l[5+x]==0&&l[6+x]==0&&l[7+x]==0){E=a*l[0+x]+512>>10;l[0+x]=E;l[1+x]=E;l[2+x]=E;l[3+x]=E;l[4+x]=E;l[5+x]=E;l[6+x]=E;l[7+x]=E;continue}h=a*l[0+x]+128>>8;p=a*l[4+x]+128>>8;d=l[2+x];v=l[6+x];g=f*(l[1+x]-l[7+x])+128>>8;w=f*(l[1+x]+l[7+x])+128>>8;y=l[3+x]<<4;b=l[5+x]<<4;E=h-p+1>>1;h=h+p+1>>1;p=E;E=d*u+v*o+128>>8;d=d*o-v*u+128>>8;v=E;E=g-b+1>>1;g=g+b+1>>1;b=E;E=w+y+1>>1;y=w-y+1>>1;w=E;E=h-v+1>>1;h=h+v+1>>1;v=E;E=p-d+1>>1;p=p+d+1>>1;d=E;E=g*s+w*i+2048>>12;g=g*i-w*s+2048>>12;w=E;E=y*r+b*n+2048>>12;y=y*n-b*r+2048>>12;b=E;l[0+x]=h+w;l[7+x]=h-w;l[1+x]=p+b;l[6+x]=p-b;l[2+x]=d+y;l[5+x]=d-y;l[3+x]=v+g;l[4+x]=v-g}for(S=0;S<8;++S){var T=S;if(l[1*8+T]==0&&l[2*8+T]==0&&l[3*8+T]==0&&l[4*8+T]==0&&l[5*8+T]==0&&l[6*8+T]==0&&l[7*8+T]==0){E=a*l[S+0]+8192>>14;l[0*8+T]=E;l[1*8+T]=E;l[2*8+T]=E;l[3*8+T]=E;l[4*8+T]=E;l[5*8+T]=E;l[6*8+T]=E;l[7*8+T]=E;continue}h=a*l[0*8+T]+2048>>12;p=a*l[4*8+T]+2048>>12;d=l[2*8+T];v=l[6*8+T];g=f*(l[1*8+T]-l[7*8+T])+2048>>12;w=f*(l[1*8+T]+l[7*8+T])+2048>>12;y=l[3*8+T];b=l[5*8+T];E=h-p+1>>1;h=h+p+1>>1;p=E;E=d*u+v*o+2048>>12;d=d*o-v*u+2048>>12;v=E;E=g-b+1>>1;g=g+b+1>>1;b=E;E=w+y+1>>1;y=w-y+1>>1;w=E;E=h-v+1>>1;h=h+v+1>>1;v=E;E=p-d+1>>1;p=p+d+1>>1;d=E;E=g*s+w*i+2048>>12;g=g*i-w*s+2048>>12;w=E;E=y*r+b*n+2048>>12;y=y*n-b*r+2048>>12;b=E;l[0*8+T]=h+w;l[7*8+T]=h-w;l[1*8+T]=p+b;l[6*8+T]=p-b;l[2*8+T]=d+y;l[5*8+T]=d-y;l[3*8+T]=v+g;l[4*8+T]=v-g}for(S=0;S<64;++S){var N=t+S;e.blockData[N]=m(l[S]+2056>>4)}}function v(e,t){var n=[];var r=t.blocksPerLine;var i=t.blocksPerColumn;var s=r<<3;var o=new Int32Array(64);var u,a,f=0;for(var l=0;l<i;l++){for(var c=0;c<r;c++){var p=h(t,l,c);d(t,p,o)}}return t.blockData}function m(e){return e<=0?0:e>=255?255:e|0}function g(e){return e<=0?0:e>=255?255:e}var t=new Int32Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]);var n=4017;var r=799;var i=3406;var s=2276;var o=1567;var u=3784;var a=5793;var f=2896;l.prototype={load:function(t){var n=new XMLHttpRequest;n.open("GET",t,true);n.responseType="arraybuffer";n.onload=function(){var e=new Uint8Array(n.response||n.mozResponseArrayBuffer);this.parse(e);if(this.onload)this.onload()}.bind(this);n.send(null)},parse:function(n){function r(){var e=n[o]<<8|n[o+1];o+=2;return e}function i(){var e=r();var t=n.subarray(o,o+e-2);o+=t.length;return t}function s(e){var t=Math.ceil(e.samplesPerLine/8/e.maxH);var n=Math.ceil(e.scanLines/8/e.maxV);for(var r=0;r<e.components.length;r++){W=e.components[r];var i=Math.ceil(Math.ceil(e.samplesPerLine/8)*W.h/e.maxH);var s=Math.ceil(Math.ceil(e.scanLines/8)*W.v/e.maxV);var o=t*W.h;var u=n*W.v;var a=64*u*(o+1);W.blockData=new Int16Array(a);W.blocksPerLine=i;W.blocksPerColumn=s}e.mcusPerLine=t;e.mcusPerColumn=n}var o=0,u=n.length;var a=null;var f=null;var l=null;var h,d;var m=[];var g=[],y=[];var b=r();if(b!=65496){throw"SOI not found"}b=r();while(b!=65497){var w,E,S;switch(b){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var x=i();if(b===65504){if(x[0]===74&&x[1]===70&&x[2]===73&&x[3]===70&&x[4]===0){a={version:{major:x[5],minor:x[6]},densityUnits:x[7],xDensity:x[8]<<8|x[9],yDensity:x[10]<<8|x[11],thumbWidth:x[12],thumbHeight:x[13],thumbData:x.subarray(14,14+3*x[12]*x[13])}}}if(b===65518){if(x[0]===65&&x[1]===100&&x[2]===111&&x[3]===98&&x[4]===101&&x[5]===0){f={version:x[6],flags0:x[7]<<8|x[8],flags1:x[9]<<8|x[10],transformCode:x[11]}}}break;case 65499:var T=r();var N=T+o-2;while(o<N){var C=n[o++];var k=new Int32Array(64);if(C>>4===0){for(E=0;E<64;E++){var L=t[E];k[L]=n[o++]}}else if(C>>4===1){for(E=0;E<64;E++){var L=t[E];k[L]=r()}}else throw"DQT: invalid table spec";m[C&15]=k}break;case 65472:case 65473:case 65474:if(h){throw"Only single frame JPEGs supported"}r();h={};h.extended=b===65473;h.progressive=b===65474;h.precision=n[o++];h.scanLines=r();h.samplesPerLine=r();h.components=[];h.componentIds={};var A=n[o++],O;var M=0,_=0;for(w=0;w<A;w++){O=n[o];var D=n[o+1]>>4;var P=n[o+1]&15;if(M<D)M=D;if(_<P)_=P;var H=n[o+2];var S=h.components.push({h:D,v:P,quantizationTable:m[H]});h.componentIds[O]=S-1;o+=3}h.maxH=M;h.maxV=_;s(h);break;case 65476:var B=r();for(w=2;w<B;){var j=n[o++];var F=new Uint8Array(16);var I=0;for(E=0;E<16;E++,o++)I+=F[E]=n[o];var q=new Uint8Array(I);for(E=0;E<I;E++,o++)q[E]=n[o];w+=17+I;(j>>4===0?y:g)[j&15]=c(F,q)}break;case 65501:r();d=r();break;case 65498:var R=r();var U=n[o++];var z=[],W;for(w=0;w<U;w++){var X=h.componentIds[n[o++]];W=h.components[X];var V=n[o++];W.huffmanTableDC=y[V>>4];W.huffmanTableAC=g[V&15];z.push(W)}var $=n[o++];var J=n[o++];var K=n[o++];var Q=p(n,o,h,z,d,$,J,K>>4,K&15);o+=Q;break;default:if(n[o-3]==255&&n[o-2]>=192&&n[o-2]<=254){o-=3;break}throw"unknown JPEG marker "+b.toString(16)}b=r()}this.width=h.samplesPerLine;this.height=h.scanLines;this.jfif=a;this.adobe=f;this.components=[];for(var w=0;w<h.components.length;w++){var W=h.components[w];this.components.push({output:v(h,W),scaleX:W.h/h.maxH,scaleY:W.v/h.maxV,blocksPerLine:W.blocksPerLine,blocksPerColumn:W.blocksPerColumn})}},getData:function(t,n){var r=this.width/t,i=this.height/n;var s,o,u;var a,f,l;var c=0;var p,d,v,m,y,b,w,E,S,x;var T;var N=this.components.length;var C=t*n*N;var k=new Uint8Array(C);var L;var A=new Uint8Array((this.components[0].blocksPerLine<<3)*this.components[0].blocksPerColumn*8);for(l=0;l<N;l++){s=this.components[l];var O=s.blocksPerLine;var M=s.blocksPerColumn;var _=O<<3;var D,P,H=0;var B=0;for(var j=0;j<M;j++){var F=j<<3;for(var I=0;I<O;I++){var q=h(s,j,I);var c=0,R=I<<3;for(D=0;D<8;D++){var B=(F+D)*_;for(P=0;P<8;P++){A[B+R+P]=s.output[q+c++]}}}}o=s.scaleX*r;u=s.scaleY*i;c=l;var U,z;var W;for(f=0;f<n;f++){for(a=0;a<t;a++){z=0|f*u;U=0|a*o;W=z*_+U;k[c]=A[W];c+=N}}}switch(N){case 1:case 2:break;case 3:T=true;if(this.adobe&&this.adobe.transformCode)T=true;else if(typeof this.colorTransform!=="undefined")T=!!this.colorTransform;if(T){for(l=0;l<C;l+=N){p=k[l];d=k[l+1];v=k[l+2];E=g(p+1.402*(v-128));S=g(p-.3441363*(d-128)-.71413636*(v-128));x=g(p+1.772*(d-128));k[l]=E;k[l+1]=S;k[l+2]=x}}break;case 4:T=false;if(this.adobe&&this.adobe.transformCode)T=true;else if(typeof this.colorTransform!=="undefined")T=!!this.colorTransform;if(T){for(l=0;l<C;l+=N){p=k[l];d=k[l+1];v=k[l+2];y=255-g(p+1.402*(v-128));b=255-g(p-.3441363*(d-128)-.71413636*(v-128));w=255-g(p+1.772*(d-128));k[l]=y;k[l+1]=b;k[l+2]=w}}break;default:throw"Unsupported color mode"}return k},copyToImageData:function(t){var n=t.width,r=t.height;var i=n*r*4;var s=t.data;var o=this.getData(n,r);var u=0,a=0;var f,l,c,h,p,d,v;switch(this.components.length){case 1:while(a<i){f=o[u++];s[a++]=f;s[a++]=f;s[a++]=f;s[a++]=255}break;case 3:while(a<i){p=o[u++];d=o[u++];v=o[u++];s[a++]=p;s[a++]=d;s[a++]=v;s[a++]=255}break;case 4:while(a<i){c=o[u++];h=o[u++];f=o[u++];l=o[u++];p=255-g(c*(1-l/255)+l);d=255-g(h*(1-l/255)+l);v=255-g(f*(1-l/255)+l);s[a++]=p;s[a++]=d;s[a++]=v;s[a++]=255}break;default:throw"Unsupported color mode"}}};return l}()
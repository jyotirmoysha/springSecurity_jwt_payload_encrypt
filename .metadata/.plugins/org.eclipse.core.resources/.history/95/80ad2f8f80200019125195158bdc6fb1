"use strict";var ChunkedStream=function(){function t(e,t,n){this.bytes=new Uint8Array(e);this.start=0;this.pos=0;this.end=e;this.chunkSize=t;this.loadedChunks=[];this.numChunksLoaded=0;this.numChunks=Math.ceil(e/t);this.manager=n;this.initialDataLength=0}t.prototype={getMissingChunks:function(){var t=[];for(var n=0,r=this.numChunks;n<r;++n){if(!(n in this.loadedChunks)){t.push(n)}}return t},getBaseStreams:function(){return[this]},allChunksLoaded:function(){return this.numChunksLoaded===this.numChunks},onReceiveData:function(t,n){var r=t+n.byteLength;assert(t%this.chunkSize===0,"Bad begin offset: "+t);var i=this.bytes.length;assert(r%this.chunkSize===0||r===i,"Bad end offset: "+r);this.bytes.set(new Uint8Array(n),t);var s=this.chunkSize;var o=Math.floor(t/s);var u=Math.floor((r-1)/s)+1;for(var n=o;n<u;++n){if(!(n in this.loadedChunks)){this.loadedChunks[n]=true;++this.numChunksLoaded}}},onReceiveInitialData:function(t){this.bytes.set(t);this.initialDataLength=t.length;var n=this.end===t.length?this.numChunks:Math.floor(t.length/this.chunkSize);for(var r=0;r<n;r++){this.loadedChunks[r]=true;++this.numChunksLoaded}},ensureRange:function(t,n){if(t>=n){return}if(n<=this.initialDataLength){return}var r=this.chunkSize;var i=Math.floor(t/r);var s=Math.floor((n-1)/r)+1;for(var o=i;o<s;++o){if(!(o in this.loadedChunks)){throw new MissingDataException(t,n)}}},nextEmptyChunk:function(t){for(var n=t,r=this.numChunks;n<r;++n){if(!(n in this.loadedChunks)){return n}}for(var n=0;n<t;++n){if(!(n in this.loadedChunks)){return n}}return null},hasChunk:function(t){return t in this.loadedChunks},get length(){return this.end-this.start},getByte:function(){var t=this.pos;if(t>=this.end){return-1}this.ensureRange(t,t+1);return this.bytes[this.pos++]},getUint16:function(){var t=this.getByte();var n=this.getByte();return(t<<8)+n},getUint32:function(){var t=this.getByte();var n=this.getByte();var r=this.getByte();var i=this.getByte();return(t<<24)+(n<<16)+(r<<8)+i},getBytes:function(t){var n=this.bytes;var r=this.pos;var i=this.end;if(!t){this.ensureRange(r,i);return n.subarray(r,i)}var s=r+t;if(s>i){s=i}this.ensureRange(r,s);this.pos=s;return n.subarray(r,s)},peekBytes:function(t){var n=this.getBytes(t);this.pos-=n.length;return n},getByteRange:function(t,n){this.ensureRange(t,n);return this.bytes.subarray(t,n)},skip:function(t){if(!t){t=1}this.pos+=t},reset:function(){this.pos=this.start},moveStart:function(){this.start=this.pos},makeSubStream:function(t,n,r){function i(){}this.ensureRange(t,t+n);i.prototype=Object.create(this);i.prototype.getMissingChunks=function(){var e=this.chunkSize;var t=Math.floor(this.start/e);var n=Math.floor((this.end-1)/e)+1;var r=[];for(var i=t;i<n;++i){if(!(i in this.loadedChunks)){r.push(i)}}return r};var s=new i;s.pos=s.start=t;s.end=t+n||this.end;s.dict=r;return s},isStream:true};return t}();var ChunkedStreamManager=function(){function t(e,t,n,r){var i=this;this.stream=new ChunkedStream(e,t,this);this.length=e;this.chunkSize=t;this.url=n;this.disableAutoFetch=r.disableAutoFetch;var s=this.msgHandler=r.msgHandler;if(r.chunkedViewerLoading){s.on("OnDataRange",this.onReceiveData.bind(this));s.on("OnDataProgress",this.onProgress.bind(this));this.sendRequest=function(t,n){s.send("RequestDataRange",{begin:t,end:n})}}else{var o=function(){return new XMLHttpRequest};this.networkManager=new NetworkManager(this.url,{getXhr:o,httpHeaders:r.httpHeaders,withCredentials:r.withCredentials});this.sendRequest=function(t,n){this.networkManager.requestRange(t,n,{onDone:this.onReceiveData.bind(this),onProgress:this.onProgress.bind(this)})}}this.currRequestId=0;this.chunksNeededByRequest={};this.requestsByChunk={};this.callbacksByRequest={};this.loadedStream=new LegacyPromise;if(r.initialData){this.setInitialData(r.initialData)}}t.prototype={setInitialData:function(t){this.stream.onReceiveInitialData(t);if(this.stream.allChunksLoaded()){this.loadedStream.resolve(this.stream)}else if(this.msgHandler){this.msgHandler.send("DocProgress",{loaded:t.length,total:this.length})}},onLoadedStream:function(){return this.loadedStream},requestAllChunks:function(){var t=this.stream.getMissingChunks();this.requestChunks(t);return this.loadedStream},requestChunks:function(t,n){var r=this.currRequestId++;var i;this.chunksNeededByRequest[r]=i={};for(var s=0,o=t.length;s<o;s++){if(!this.stream.hasChunk(t[s])){i[t[s]]=true}}if(isEmptyObj(i)){if(n){n()}return}this.callbacksByRequest[r]=n;var u=[];for(var a in i){a=a|0;if(!(a in this.requestsByChunk)){this.requestsByChunk[a]=[];u.push(a)}this.requestsByChunk[a].push(r)}if(!u.length){return}var f=this.groupChunks(u);for(var s=0;s<f.length;++s){var l=f[s];var c=l.beginChunk*this.chunkSize;var h=Math.min(l.endChunk*this.chunkSize,this.length);this.sendRequest(c,h)}},getStream:function(){return this.stream},requestRange:function(t,n,r){n=Math.min(n,this.length);var i=this.getBeginChunk(t);var s=this.getEndChunk(n);var o=[];for(var u=i;u<s;++u){o.push(u)}this.requestChunks(o,r)},requestRanges:function(t,n){t=t||[];var r=[];for(var i=0;i<t.length;i++){var s=this.getBeginChunk(t[i].begin);var o=this.getEndChunk(t[i].end);for(var u=s;u<o;++u){if(r.indexOf(u)<0){r.push(u)}}}r.sort(function(e,t){return e-t});this.requestChunks(r,n)},groupChunks:function(t){var n=[];var r=-1;var i=-1;for(var s=0;s<t.length;++s){var o=t[s];if(r<0){r=o}if(i>=0&&i+1!==o){n.push({beginChunk:r,endChunk:i+1});r=o}if(s+1===t.length){n.push({beginChunk:r,endChunk:o+1})}i=o}return n},onProgress:function(t){var n=this.stream.numChunksLoaded*this.chunkSize+t.loaded;this.msgHandler.send("DocProgress",{loaded:n,total:this.length})},onReceiveData:function(t){var n=t.chunk;var r=t.begin;var i=r+n.byteLength;var s=this.getBeginChunk(r);var o=this.getEndChunk(i);this.stream.onReceiveData(r,n);if(this.stream.allChunksLoaded()){this.loadedStream.resolve(this.stream)}var u=[];for(var n=s;n<o;++n){var a=this.requestsByChunk[n]||[];delete this.requestsByChunk[n];for(var f=0;f<a.length;++f){var l=a[f];var c=this.chunksNeededByRequest[l];if(n in c){delete c[n]}if(!isEmptyObj(c)){continue}u.push(l)}}if(!this.disableAutoFetch&&isEmptyObj(this.requestsByChunk)){var h;if(this.stream.numChunksLoaded===1){var p=this.stream.numChunks-1;if(!this.stream.hasChunk(p)){h=p}}else{h=this.stream.nextEmptyChunk(o)}if(isInt(h)){this.requestChunks([h])}}for(var f=0;f<u.length;++f){var l=u[f];var d=this.callbacksByRequest[l];delete this.callbacksByRequest[l];if(d){d()}}this.msgHandler.send("DocProgress",{loaded:this.stream.numChunksLoaded*this.chunkSize,total:this.length})},getBeginChunk:function(t){var n=Math.floor(t/this.chunkSize);return n},getEndChunk:function(t){if(t%this.chunkSize===0){return t/this.chunkSize}var n=Math.floor((t-1)/this.chunkSize)+1;return n}};return t}()
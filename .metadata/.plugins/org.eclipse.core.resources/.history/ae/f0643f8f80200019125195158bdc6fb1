"use strict";var HIGHLIGHT_OFFSET=4;var SUPPORTED_TYPES=["Link","Text","Widget"];var Annotation=function(){function t(e,t,n){var r=Util.getAxialAlignedBoundingBox(t,n);var i=r[0];var s=r[1];var o=r[2];var u=r[3];if(i===o||s===u){return[1,0,0,1,e[0],e[1]]}var a=(e[2]-e[0])/(o-i);var f=(e[3]-e[1])/(u-s);return[a,0,0,f,e[0]-i*a,e[1]-s*f]}function n(e){var t=e.get("AP");if(!isDict(t)){return}var n;var r=t.get("N");if(isDict(r)){var i=e.get("AS");if(i&&r.has(i.name)){n=r.get(i.name)}}else{n=r}return n}function r(e){if(e.data){this.data=e.data;return}var t=e.dict;var r=this.data={};r.subtype=t.get("Subtype").name;var i=t.get("Rect");r.rect=Util.normalizeRect(i);r.annotationFlags=t.get("F");var s=t.get("C");if(isArray(s)&&s.length===3){r.color=s}else{r.color=[0,0,0]}if(t.has("BS")){var o=t.get("BS");r.borderWidth=o.has("W")?o.get("W"):1}else{var u=t.get("Border")||[0,0,1];r.borderWidth=u[2]||0;var a=u[3];if(r.borderWidth>0&&a&&isArray(a)){var f=a.length;if(f>0){var l=false;var c=0;for(var h=0;h<f;h++){if(!(+a[h]>=0)){l=true;break}else if(a[h]>0){c++}}if(l||c===0){r.borderWidth=0}}}}this.appearance=n(t);r.hasAppearance=!!this.appearance}r.prototype={getData:function(){return this.data},hasHtml:function(){return false},getHtmlElement:function(t){throw new NotImplementedException("getHtmlElement() should be implemented in subclass")},getEmptyContainer:function(t,n,r){assert(!isWorker,"getEmptyContainer() should be called from main thread");var i=r||0;n=n||this.data.rect;var s=document.createElement(t);s.style.borderWidth=i+"px";var o=n[2]-n[0]-2*i;var u=n[3]-n[1]-2*i;s.style.width=o+"px";s.style.height=u+"px";return s},isInvisible:function(){var t=this.data;if(t&&SUPPORTED_TYPES.indexOf(t.subtype)!==-1){return false}else{return!!(t&&t.annotationFlags&&t.annotationFlags&1)}},isViewable:function(){var t=this.data;return!!(!this.isInvisible()&&t&&(!t.annotationFlags||!(t.annotationFlags&34))&&t.rect)},isPrintable:function(){var t=this.data;return!!(!this.isInvisible()&&t&&t.annotationFlags&&t.annotationFlags&4&&t.rect)},loadResources:function(e){var t=new LegacyPromise;this.appearance.dict.getAsync("Resources").then(function(n){if(!n){t.resolve();return}var r=new ObjectLoader(n.map,e,n.xref);r.load().then(function(){t.resolve(n)})}.bind(this));return t},getOperatorList:function(n){var r=new LegacyPromise;if(!this.appearance){r.resolve(new OperatorList);return r}var i=this.data;var s=this.appearance.dict;var o=this.loadResources(["ExtGState","ColorSpace","Pattern","Shading","XObject","Font"]);var u=s.get("BBox")||[0,0,1,1];var a=s.get("Matrix")||[1,0,0,1,0,0];var f=t(i.rect,u,a);var l=i.border;o.then(function(e){var t=new OperatorList;t.addOp(OPS.beginAnnotation,[i.rect,f,a]);n.getOperatorList(this.appearance,e,t);t.addOp(OPS.endAnnotation,[]);r.resolve(t);this.appearance.reset()}.bind(this));return r}};r.getConstructor=function(t,n){if(!t){return}if(t==="Link"){return LinkAnnotation}else if(t==="Text"){return TextAnnotation}else if(t==="Highlight"){return LinkAnnotation}else if(t==="Widget"){if(!n){return}if(n==="Tx"){return TextWidgetAnnotation}else{return WidgetAnnotation}}else{return r}};r.fromData=function(t){var n=t.subtype;var i=t.fieldType;var s=r.getConstructor(n,i);if(s){return new s({data:t})}};r.fromRef=function(t,n){var i=t.fetchIfRef(n);if(!isDict(i)){return}var s=i.get("Subtype");s=isName(s)?s.name:"";if(!s){return}var o=Util.getInheritableProperty(i,"FT");o=isName(o)?o.name:"";var u=r.getConstructor(s,o);if(!u){return}var a={dict:i,ref:n};var f=new u(a);if(f.isViewable()||f.isPrintable()){return f}else{warn("unimplemented annotation type: "+s)}};r.appendToOperatorList=function(t,n,r,i,s){function o(e){u.reject(e)}var u=new LegacyPromise;var a=[];for(var f=0,l=t.length;f<l;++f){if(s==="display"&&t[f].isViewable()||s==="print"&&t[f].isPrintable()){a.push(t[f].getOperatorList(i))}}Promise.all(a).then(function(e){n.addOp(OPS.beginAnnotations,[]);for(var t=0,r=e.length;t<r;++t){var i=e[t];n.addOpList(i)}n.addOp(OPS.endAnnotations,[]);u.resolve()},o);return u};return r}();PDFJS.Annotation=Annotation;var WidgetAnnotation=function(){function t(e){Annotation.call(this,e);if(e.data){return}var t=e.dict;var n=this.data;n.fieldValue=stringToPDFString(Util.getInheritableProperty(t,"V")||"");n.alternativeText=stringToPDFString(t.get("TU")||"");n.defaultAppearance=Util.getInheritableProperty(t,"DA")||"";var r=Util.getInheritableProperty(t,"FT");n.fieldType=isName(r)?r.name:"";n.fieldFlags=Util.getInheritableProperty(t,"Ff")||0;this.fieldResources=Util.getInheritableProperty(t,"DR")||new Dict;var i=[];var s=t;var o=e.ref;while(s){var u=s.get("Parent");var a=s.getRaw("Parent");var f=s.get("T");if(f){i.unshift(stringToPDFString(f))}else{var l=u.get("Kids");var c,h;for(c=0,h=l.length;c<h;c++){var p=l[c];if(p.num==o.num&&p.gen==o.gen){break}}i.unshift("`"+c)}s=u;o=a}n.fullName=i.join(".")}var n=Annotation.prototype;Util.inherit(t,Annotation,{isViewable:function(){if(this.data.fieldType==="Sig"){warn("unimplemented annotation type: Widget signature");return false}return n.isViewable.call(this)}});return t}();var TextWidgetAnnotation=function(){function t(e){WidgetAnnotation.call(this,e);if(e.data){return}this.data.textAlignment=Util.getInheritableProperty(e.dict,"Q")}function n(e,t,n){var r=e.style;r.fontSize=t.fontSize+"px";r.direction=t.fontDirection<0?"rtl":"ltr";if(!n){return}r.fontWeight=n.black?n.bold?"bolder":"bold":n.bold?"bold":"normal";r.fontStyle=n.italic?"italic":"normal";var i=n.loadedName;var s=i?'"'+i+'", ':"";var o=n.fallbackName||"Helvetica, sans-serif";r.fontFamily=s+o}var r=WidgetAnnotation.prototype;Util.inherit(t,WidgetAnnotation,{hasHtml:function(){return!this.data.hasAppearance&&!!this.data.fieldValue},getHtmlElement:function(t){assert(!isWorker,"getHtmlElement() shall be called from main thread");var r=this.data;var i=this.getEmptyContainer("div");i.style.display="table";var s=document.createElement("div");s.textContent=r.fieldValue;var o=r.textAlignment;s.style.textAlign=["left","center","right"][o];s.style.verticalAlign="middle";s.style.display="table-cell";var u=r.fontRefName?t.getData(r.fontRefName):null;var a=n(s,r,u);i.appendChild(s);return i},getOperatorList:function(t){if(this.appearance){return Annotation.prototype.getOperatorList.call(this,t)}var n=new LegacyPromise;var r=new OperatorList;var i=this.data;var s=i.defaultAppearance;if(!s){n.resolve(r);return n}var o=new Stream(stringToBytes(s));t.getOperatorList(o,this.fieldResources,r);var u=r.fnArray;var a=r.argsArray;var f=[];var l=[];i.rgb=[0,0,0];for(var c=0,h=f.length;c<h;++c){var p=u[c];var d=a[c];if(p===OPS.setFont){i.fontRefName=d[0];var v=d[1];if(v<0){i.fontDirection=-1;i.fontSize=-v}else{i.fontDirection=1;i.fontSize=v}}else if(p===OPS.setFillRGBColor){i.rgb=d}else if(p===OPS.setFillGray){var m=d[0]*255;i.rgb=[m,m,m]}}n.resolve(r);return n}});return t}();var InteractiveAnnotation=function(){function t(e){Annotation.call(this,e)}Util.inherit(t,Annotation,{hasHtml:function(){return true},highlight:function(){if(this.highlightElement&&this.highlightElement.hasAttribute("hidden")){this.highlightElement.removeAttribute("hidden")}},unhighlight:function(){if(this.highlightElement&&!this.highlightElement.hasAttribute("hidden")){this.highlightElement.setAttribute("hidden",true)}},initContainer:function(){var t=this.data;var n=t.rect;var r=this.getEmptyContainer("section",n,t.borderWidth);r.style.backgroundColor=t.color;var i=t.color;var s=[];for(var o=0;o<3;++o){s[o]=Math.round(i[o]*255)}t.colorCssRgb=Util.makeCssRgb(s);var u=document.createElement("div");u.className="annotationHighlight";u.style.left=u.style.top=-HIGHLIGHT_OFFSET+"px";u.style.right=u.style.bottom=-HIGHLIGHT_OFFSET+"px";u.setAttribute("hidden",true);this.highlightElement=u;r.appendChild(this.highlightElement);return r}});return t}();var TextAnnotation=function(){function t(e){InteractiveAnnotation.call(this,e);if(e.data){return}var t=e.dict;var n=this.data;var r=t.get("Contents");var i=t.get("T");n.content=stringToPDFString(r||"");n.title=stringToPDFString(i||"");if(n.hasAppearance){n.name="NoIcon"}else{n.name=t.has("Name")?t.get("Name").name:"Note"}if(t.has("C")){n.hasBgColor=true}}var n=10;Util.inherit(t,InteractiveAnnotation,{getHtmlElement:function(t){assert(!isWorker,"getHtmlElement() shall be called from main thread");var r=this.data;var i=r.rect;if(i[3]-i[1]<n){i[3]=i[1]+n}if(i[2]-i[0]<n){i[2]=i[0]+(i[3]-i[1])}var s=this.initContainer();s.className="annotText";var o=document.createElement("img");o.style.height=s.style.height;o.style.width=s.style.width;var u=r.name;o.src=PDFJS.imageResourcesPath+"annotation-"+u.toLowerCase()+".svg";o.alt="[{{type}} Annotation]";o.dataset.l10nId="text_annotation_type";o.dataset.l10nArgs=JSON.stringify({type:u});var a=document.createElement("div");a.className="annotTextContentWrapper";a.style.left=Math.floor(i[2]-i[0]+5)+"px";a.style.top="-10px";var f=document.createElement("div");f.className="annotTextContent";f.setAttribute("hidden",true);if(r.hasBgColor){var l=r.color;var c=[];for(var h=0;h<3;++h){var p=Math.round(l[h]*255);c[h]=Math.round((255-p)*.7)+p}f.style.backgroundColor=Util.makeCssRgb(c)}var d=document.createElement("h1");var v=document.createElement("p");d.textContent=r.title;if(!r.content&&!r.title){f.setAttribute("hidden",true)}else{var m=document.createElement("span");var g=r.content.split(/(?:\r\n?|\n)/);for(var h=0,y=g.length;h<y;++h){var b=g[h];m.appendChild(document.createTextNode(b));if(h<y-1){m.appendChild(document.createElement("br"))}}v.appendChild(m);var w=false;var E=function(t){if(t){w=true}if(f.hasAttribute("hidden")){s.style.zIndex+=1;f.removeAttribute("hidden")}};var S=function(t){if(t){w=false}if(!f.hasAttribute("hidden")&&!w){s.style.zIndex-=1;f.setAttribute("hidden",true)}};var x=function(){if(w){S(true)}else{E(true)}};var T=this;o.addEventListener("click",function(){x()},false);o.addEventListener("mouseover",function(){E()},false);o.addEventListener("mouseout",function(){S()},false);f.addEventListener("click",function(){S(true)},false)}f.appendChild(d);f.appendChild(v);a.appendChild(f);s.appendChild(o);s.appendChild(a);return s}});return t}();var LinkAnnotation=function(){function t(e){InteractiveAnnotation.call(this,e);if(e.data){return}var t=e.dict;var r=this.data;var i=t.get("A");if(i){var s=i.get("S").name;if(s==="URI"){var o=i.get("URI");if(isName(o)){o="/"+o.name}else if(o){o=n(o)}if(!isValidUrl(o,false)){o=""}r.url=o}else if(s==="GoTo"){r.dest=i.get("D")}else if(s==="GoToR"){var u=i.get("F");if(isDict(u)){o=u.get("F")||""}if(!isValidUrl(o,false)){o=""}r.url=o;r.dest=i.get("D")}else if(s==="Named"){r.action=i.get("N").name}else{warn("unrecognized link type: "+s)}}else if(t.has("Dest")){var a=t.get("Dest");r.dest=isName(a)?a.name:a}}function n(e){if(e&&e.indexOf("www.")===0){return"http://"+e}return e}Util.inherit(t,InteractiveAnnotation,{hasOperatorList:function(){return false},getHtmlElement:function(t){var n=this.initContainer();n.className="annotLink";var r=this.data;var i=r.rect;var s=r.color;var o=[];for(var u=0;u<3;++u){var a=Math.round(s[u]*255);o[u]=Math.round((255-a)*.7)+a}console.log("my color="+r.colorCssRgb);if(r.colorCssRgb=="rgb(0,255,0)"){n.style.backgroundColor=r.colorCssRgb;n.style.opacity="0.2";n.style.zIndex+=1}return n}});return t}()